{% extends "base.html" %}

{% block title %}Leaderboard - Introduction Leader{% endblock %}

{% block content %}
<div class="container">
    <h1>Leaderboard</h1>
    
    <form method="GET" action="{{ url_for('main.leaderboard') }}" class="filter-form">
        <div class="form-group">
            {{ filter_form.region.label }}
            {{ filter_form.region(class="form-control") }}
        </div>
        <div class="form-group">
            {{ filter_form.date_from.label }}
            {{ filter_form.date_from(class="form-control") }}
        </div>
        <div class="form-group">
            {{ filter_form.date_to.label }}
            {{ filter_form.date_to(class="form-control") }}
        </div>
        <div class="form-group">
            {{ filter_form.metric.label }}
            {{ filter_form.metric(class="form-control") }}
        </div>
        <div class="form-group">
            <label>&nbsp;</label>
            <button type="submit" class="btn">Apply Filters</button>
            <a href="{{ url_for('main.leaderboard') }}" class="btn btn-secondary">Clear</a>
        </div>
    </form>
    
    {% if leaderboard_data %}
        <table>
            <thead>
                <tr>
                    <th onclick="sortTable('name')">Name ↑↓</th>
                    <th onclick="sortTable('region')">Region ↑↓</th>
                    <th onclick="sortTable('total_registrations')">Registrations ↑↓</th>
                    <th onclick="sortTable('total_guests')">Guests ↑↓</th>
                    <th onclick="sortTable('effectiveness_pct')">Effectiveness % ↑↓</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body">
                {% for person in leaderboard_data %}
                    <tr>
                        <td>{{ person.name }}</td>
                        <td>{{ person.region }}</td>
                        <td>{{ person.total_registrations }}</td>
                        <td>{{ person.total_guests }}</td>
                        <td>{{ "%.2f"|format(person.effectiveness_pct) }}%</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No data available for the selected filters.</p>
    {% endif %}
    
    <a href="{{ url_for('main.dashboard') }}" class="btn">Back to Dashboard</a>
</div>

<script>
// Simple client-side table sorting (no framework)
let sortDirection = {};
function sortTable(column) {
    const tbody = document.getElementById('leaderboard-body');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    const direction = sortDirection[column] || 'asc';
    sortDirection[column] = direction === 'asc' ? 'desc' : 'asc';
    
    rows.sort((a, b) => {
        const aVal = a.querySelector(`td:nth-child(${getColumnIndex(column)})`).textContent.trim();
        const bVal = b.querySelector(`td:nth-child(${getColumnIndex(column)})`).textContent.trim();
        
        let aNum = parseFloat(aVal.replace('%', ''));
        let bNum = parseFloat(bVal.replace('%', ''));
        
        if (!isNaN(aNum) && !isNaN(bNum)) {
            return direction === 'asc' ? aNum - bNum : bNum - aNum;
        }
        
        return direction === 'asc' 
            ? aVal.localeCompare(bVal)
            : bVal.localeCompare(aVal);
    });
    
    rows.forEach(row => tbody.appendChild(row));
}

function getColumnIndex(column) {
    const map = {
        'name': 1,
        'region': 2,
        'total_registrations': 3,
        'total_guests': 4,
        'effectiveness_pct': 5
    };
    return map[column] || 1;
}
</script>
{% endblock %}
